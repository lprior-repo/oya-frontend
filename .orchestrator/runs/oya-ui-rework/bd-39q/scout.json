{
  "bead_id": "bd-39q",
  "phase": "SCOUT",
  "agent_id": "scout-agent",
  "findings": {
    "current_node_struct": "Node struct in src/graph/mod.rs (lines 78-94) has 14 fields: id (NodeId), name (String), description (String), node_type (String), category (NodeCategory), icon (String), x/y (f32), config (serde_json::Value), last_output (Option<serde_json::Value>), selected/executing/skipped (bool), error (Option<String>). The stringly-typed fields are node_type: String and config: serde_json::Value.",
    "existing_workflow_node_variants": [
      "HttpTrigger(HttpTriggerConfig)",
      "ScheduleTrigger(ScheduleTriggerConfig)",
      "ServiceCall(ServiceCallConfig)",
      "SendMessage(SendMessageConfig)",
      "DelayedMessage(DelayedMessageConfig)",
      "SaveToMemory(SaveToMemoryConfig)",
      "LoadFromMemory(LoadFromMemoryConfig)",
      "Delay(DelayConfig)",
      "Router(RouterConfig)",
      "WaitForWebhook(WaitForWebhookConfig)",
      "WaitForSignal(WaitForSignalConfig)",
      "RunCode(RunCodeConfig)"
    ],
    "existing_workflow_node_note": "The existing WorkflowNode enum in src/ui/workflow_nodes/schema.rs has 12 variants but is UNUSED in the codebase. It does NOT match the 24 NODE_TEMPLATES. Missing variants include: KafkaTrigger, WorkflowSubmit, ObjectCall, WorkflowCall, GetState, ClearState, Condition, Switch, Loop, Parallel, Compensate, Timeout.",
    "node_templates": [
      "http-handler",
      "kafka-handler",
      "cron-trigger",
      "workflow-submit",
      "run",
      "service-call",
      "object-call",
      "workflow-call",
      "send-message",
      "delayed-send",
      "get-state",
      "set-state",
      "clear-state",
      "condition",
      "switch",
      "loop",
      "parallel",
      "compensate",
      "sleep",
      "timeout",
      "durable-promise",
      "awakeable",
      "resolve-promise",
      "signal-handler"
    ],
    "node_templates_by_category": {
      "Entry": ["http-handler", "kafka-handler", "cron-trigger", "workflow-submit"],
      "Durable": ["run", "service-call", "object-call", "workflow-call", "send-message", "delayed-send"],
      "State": ["get-state", "set-state", "clear-state"],
      "Flow": ["condition", "switch", "loop", "parallel", "compensate"],
      "Timing": ["sleep", "timeout"],
      "Signal": ["durable-promise", "awakeable", "resolve-promise", "signal-handler"]
    },
    "node_type_usage_sites": [
      "src/graph/mod.rs:83 - struct field definition",
      "src/graph/core.rs:32,44,59 - add_node() parameter and assignment",
      "src/graph/execution.rs:82,86-108,195,198 - execute_node_type() match and comparisons",
      "src/graph/metadata.rs:4-131 - node_metadata() lookup function",
      "src/ui/sidebar/model.rs:73,101-331 - NodeTemplate struct and all 24 template constants",
      "src/ui/sidebar/presentation.rs:181,185,186 - template rendering with node_type key",
      "src/ui/command_palette.rs:5,12-77 - CommandTemplate struct and 14 templates",
      "src/ui/app_bootstrap.rs:10,26,42 - default workflow node creation",
      "src/ui/minimap.rs:249 - minimap test node",
      "src/ui/sidebar/tests.rs:33,49,65,83,128,132,137 - test assertions",
      "src/main.rs:197,368,371 - event handlers for node_type",
      "src/hooks/use_workflow_state.rs:84,90 - add_node function signatures",
      "src/hooks/use_sidebar.rs:34,39 - sidebar state management",
      "src/flow_extender/mod.rs:272,315,719,745,816,842,869,892,1003,1052-1059,1289,1366,1426,1478,1482,1537,1599,1709,1908,1912,1916 - extensive node_type string comparisons for extension logic"
    ],
    "config_access_sites": [
      "src/graph/mod.rs:88 - struct field definition (serde_json::Value)",
      "src/graph/core.rs:6,12 - set_node_status() modifies config",
      "src/graph/execution.rs:6-28,193,259 - resolve_expressions() and run() access config",
      "src/ui/node.rs:47,104,135,140,150,152,155,160 - status/configured/journalIndex/retryCount/idempotencyKey reads",
      "src/ui/config_panel/mod.rs:31,99 - config clone for editors",
      "src/ui/config_panel/config_sections.rs - all config field reads via get_str_val/get_u64_val: cronExpression, topic, workflowKey, durableStepName, targetService, targetHandler, sleepDuration, stateKey, conditionExpression, loopIterator, compensationHandler, timeoutMs, promiseName",
      "src/ui/selected_node_panel.rs:111 - config assignment on change",
      "src/ui/edges.rs:244 - config.get(\"status\") for edge rendering",
      "src/flow_extender/mod.rs:954,960,968,1716 - flow_extender metadata injection"
    ],
    "config_fields_by_node_type": {
      "http-handler": "configured, status, journalIndex",
      "kafka-handler": "topic",
      "cron-trigger": "cronExpression",
      "workflow-submit": "workflowKey",
      "run": "configured, status, durableStepName, journalIndex",
      "service-call": "durableStepName, targetService, targetHandler",
      "object-call": "durableStepName, targetService, targetHandler",
      "workflow-call": "durableStepName, targetService, targetHandler",
      "send-message": "durableStepName, targetService, targetHandler, sleepDuration (for delayed)",
      "delayed-send": "sleepDuration",
      "get-state": "stateKey",
      "set-state": "stateKey",
      "clear-state": "stateKey",
      "condition": "configured, status, conditionExpression, journalIndex",
      "switch": "branches (array of RouterBranch)",
      "loop": "loopIterator",
      "parallel": "none specific",
      "compensate": "compensationHandler",
      "sleep": "sleepDuration",
      "timeout": "timeoutMs (u64)",
      "durable-promise": "promiseName",
      "awakeable": "promiseName, timeoutMs",
      "resolve-promise": "promiseName",
      "signal-handler": "none specific",
      "_runtime": "status, configured, journalIndex, retryCount, idempotencyKey, flow_extender (metadata), pinnedOutputSample"
    },
    "migration_challenges": [
      "BREAKING CHANGE: Node struct serialization format will change - existing saved workflows may not deserialize",
      "24 node_type strings must become 24 enum variants with PascalCase naming (http-handler -> HttpHandler)",
      "All config fields currently stored as serde_json::Value must be typed - need config structs per variant",
      "flow_extender/mod.rs has extensive string comparisons that need enum pattern matching",
      "Command palette has only 14 templates vs 24 in sidebar - inconsistency to resolve",
      "Runtime fields (status, configured, journalIndex, retryCount, idempotencyKey) need separate handling - not part of node config schema",
      "The existing schema.rs WorkflowNode is unused and incomplete - should be extended, not kept",
      "PreviewNode in flow_extender uses node_type: String - needs migration too",
      "serde_json::Value config is used for expression resolution - typed config may need .into() or separate representation",
      "Default values for missing config fields need to be defined per variant",
      "icon field is currently String but derived from node_type - could be computed from variant",
      "category field is currently separate but could be derived from WorkflowNode variant"
    ],
    "recommended_approach": {
      "phase_1_enum_definition": "Create WorkflowNode enum in src/graph/mod.rs (NOT in ui/workflow_nodes) with 24 variants matching NODE_TEMPLATES. Use serde(tag='type') for JSON compatibility. Each variant wraps a typed config struct. Add TryFrom<String> and From<WorkflowNode> for Display.",
      "phase_2_config_structs": "Define config structs per category: EntryConfig (HttpHandlerConfig, KafkaHandlerConfig, CronTriggerConfig, WorkflowSubmitConfig), DurableConfig (RunConfig, ServiceCallConfig, ObjectCallConfig, WorkflowCallConfig, SendMessageConfig, DelayedSendConfig), StateConfig (GetStateConfig, SetStateConfig, ClearStateConfig), FlowConfig (ConditionConfig, SwitchConfig, LoopConfig, ParallelConfig, CompensateConfig), TimingConfig (SleepConfig, TimeoutConfig), SignalConfig (DurablePromiseConfig, AwakeableConfig, ResolvePromiseConfig, SignalHandlerConfig).",
      "phase_3_runtime_state": "Create separate NodeRuntimeState struct for execution state: status (enum), configured (bool), journal_index (Option<u64>), retry_count (u64), idempotency_key (Option<String>), last_output, error, executing, skipped. Keep this OUT of the typed config.",
      "phase_4_node_migration": "Replace node_type: String + config: Value with workflow_node: WorkflowNode in Node struct. Add runtime_state: NodeRuntimeState. Provide From<OldNode> for migration.",
      "phase_5_site_updates": "Update all 39+ node_type usage sites to use enum pattern matching. Update all 22+ config access sites to use typed accessor methods or pattern match on WorkflowNode variant.",
      "phase_6_cleanup": "Remove unused src/ui/workflow_nodes/schema.rs. Update PreviewNode to use WorkflowNode. Remove node_metadata() function - category/icon derived from variant. Consolidate command palette templates to match sidebar.",
      "serde_strategy": "Use #[serde(tag='type')] on WorkflowNode enum to maintain 'type' field in JSON output for backward compatibility. Use #[serde(rename_all='kebab-case')] for variant names to match existing node_type strings.",
      "testing_priority": "Focus on serialization roundtrip tests, flow_extender logic preservation, and config panel rendering after migration."
    },
    "suggested_workflow_node_skeleton": "pub enum WorkflowNode { #[serde(rename='http-handler')] HttpHandler(HttpHandlerConfig), #[serde(rename='kafka-handler')] KafkaHandler(KafkaHandlerConfig), ... } impl WorkflowNode { pub fn category(&self) -> NodeCategory { match self { Self::HttpHandler(_) | Self::KafkaHandler(_) | Self::CronTrigger(_) | Self::WorkflowSubmit(_) => NodeCategory::Entry, ... } } pub fn icon(&self) -> &'static str { ... } }"
  },
  "artifacts": [],
  "timestamp_utc": "2026-02-22T12:00:00Z"
}
