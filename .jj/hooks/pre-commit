#!/bin/sh
# ZJJ JJ Pre-Commit Hook - CANNOT be bypassed with --no-verify

if [ -z "$ZJJ_ACTIVE" ]; then
    echo ""
    echo "JJ commit blocked: not in a zjj workspace"
    echo "Use: zjj spawn <bead-id>"
    echo ""
    exit 1
fi

if [ "${CODANNA_SKIP_HOOK:-0}" = "1" ]; then
    exit 0
fi

if ! command -v codanna >/dev/null 2>&1; then
    exit 0
fi

if [ ! -f ".codanna/settings.toml" ]; then
    exit 0
fi

changed_paths="$(jj diff --name-only 2>/dev/null || true)"
needs_update=0
for path in $changed_paths; do
    case "$path" in
        src/*|tests/*|crates/*|docs/*|*.rs|*.md|*.toml|*.ts|*.tsx|*.js|*.jsx|*.py|*.go)
            needs_update=1
            break
            ;;
    esac
done

if [ "$needs_update" -eq 0 ]; then
    exit 0
fi

echo "[codanna] updating code index..."
codanna --config .codanna/settings.toml index >/dev/null

echo "[codanna] updating docs index..."
codanna --config .codanna/settings.toml documents index >/dev/null || true

exit 0
